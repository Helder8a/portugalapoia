<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controlo Unificado - PortugalApoia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        :root {
            --color-primary: #0A3D62;
            --color-accent: #00834B;
            --color-donation: #ffd700;
            --color-urgent: #e74c3c;
            --color-error: #c0392b;
            --color-blog: #9b59b6;
            --color-background: #F8F9FA;
            --color-surface: #ffffff;
            --color-text: #333;
            --color-border: #dee2e6;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.07);
            --font-headings: 'Inter', sans-serif;
            --font-body: 'Roboto', sans-serif;
        }
        html[data-theme='dark'] {
            --color-primary: #4e9ad1;
            --color-accent: #2ecc71;
            --color-background: #121212;
            --color-surface: #1e1e1e;
            --color-text: #e0e0e0;
            --color-border: #444;
        }
        body {
            font-family: var(--font-body);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        h1, h2, h3, h4 { color: var(--color-primary); font-family: var(--font-headings); }
        .main-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; align-items: start; }
        .form-section, .preview-section { background-color: var(--color-surface); padding: 25px; border-radius: 8px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 18px; }
        .form-group-checkbox { display: flex; align-items: center; gap: 10px; margin-top: 20px;}
        label { font-weight: 600; margin-bottom: 6px; display: block; }
        label small { font-weight: 400; color: #777; }
        html[data-theme='dark'] label small { color: #aaa; }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--color-border);
            border-radius: 8px; font-size: 1rem; box-sizing: border-box;
            background-color: var(--color-background); color: var(--color-text);
            transition: border-color .3s, box-shadow .3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(0, 131, 75, 0.2);
        }
        input[type="color"] { padding: 5px; height: 45px; }
        input[type="checkbox"] { width: auto; }
        .button {
            background-color: var(--color-accent); color: #fff; padding: 12px 28px;
            border: none; border-radius: 50px; cursor: pointer; font-size: 1rem;
            font-weight: 700; transition: all 0.3s ease;
        }
        .button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .button.secondary { background-color: #6c757d; }
        .button.small { padding: 5px 10px; font-size: 0.8em; }
        .code-output-wrapper { position: relative; }
        .code-output, .code-output-display {
            width: 100%; min-height: 200px; font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.9em; border-radius: 8px; box-sizing: border-box;
        }
        .code-output {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; resize: none;
            z-index: -1; opacity: 0;
        }
        .code-output-display {
            background-color: #2d2d2d; color: #f8f8f2; white-space: pre-wrap;
            word-wrap: break-word; overflow: auto; padding: 15px;
            border: 1px solid var(--color-border);
        }
        .copy-btn {
            position: absolute; top: 10px; right: 10px; z-index: 10;
            background-color: #444; color: white; border: none;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            font-size: 0.8rem;
        }
        .copy-btn:hover { background-color: var(--color-accent); }
        .error-message { color: var(--color-error); font-size: 0.85em; margin-top: 5px; display: none; }
        input.invalid, textarea.invalid { border-color: var(--color-error); }
        details { border: 1px solid var(--color-border); border-radius: 8px; margin-bottom: 15px; }
        details > summary { padding: 15px; font-weight: 700; cursor: pointer; color: var(--color-primary); list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before { content: '\25B6'; margin-right: 10px; transition: transform 0.2s; }
        details[open] > summary::before { transform: rotate(90deg); }
        details[open] > summary { border-bottom: 1px solid var(--color-border); }
        .details-content { padding: 20px; }
        .drop-zone {
            border: 2px dashed var(--color-border); border-radius: 8px; padding: 30px;
            text-align: center; color: #aaa; cursor: pointer; transition: background-color .3s, border-color .3s;
        }
        .drop-zone.dragover { background-color: var(--color-accent); border-color: var(--color-accent); color: white; }
        #image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .img-preview { position: relative; width: 100px; height: 100px; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .remove-img-btn {
            position: absolute; top: -5px; right: -5px; background: var(--color-error);
            color: white; border: none; border-radius: 50%; width: 22px; height: 22px;
            cursor: pointer; font-weight: bold; line-height: 20px; text-align: center;
        }
        #color-palette { display: flex; gap: 10px; margin-top: 10px; }
        .color-swatch {
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; border: 2px solid var(--color-border);
        }
        #history-section { margin-top: 30px; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #history-table th, #history-table td {
            border: 1px solid var(--color-border); padding: 8px; text-align: left;
            font-size: 0.9em;
        }
        #history-table th { background-color: var(--color-background); }
        html[data-theme='dark'] #history-table th { background-color: #2a2a2a; }
        .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 20px; right: 20px; }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; }
        input:checked+.slider { background-color: var(--color-accent); }
        input:checked+.slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* Card (Anuncio) & Blog Preview Styles */
        .card-causa { position: relative; background-color: var(--color-surface); border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; max-width: 350px; margin: auto; border: 2px solid transparent; transition: all 0.3s ease; }
        .card-causa.destacado { border-color: var(--color-donation); }
        .card-carousel-container { position: relative; width: 100%; overflow: hidden; background-color: #f0f0f0; }
        html[data-theme='dark'] .card-carousel-container { background-color: #333; }
        .card-carousel-slides { display: flex; transition: transform 0.4s ease-in-out; }
        .card-carousel-slide { min-width: 100%; box-sizing: border-box; position: relative; padding-bottom: 56.25%; height: 0; background-color: #000; }
        .card-carousel-slide img, .card-carousel-slide iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border: none; }
        .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.4); color: white; border: none; cursor: pointer; padding: 8px; z-index: 2; border-radius: 50%; width: 35px; height: 35px; font-size: 16px; }
        .carousel-btn.prev { left: 10px; }
        .carousel-btn.next { right: 10px; }
        .new-tag, .status-tag, .card-tag-blog { position: absolute; top: 12px; color: #fff; padding: 5px 12px; border-radius: 20px; font-size: .8rem; font-weight: 700; z-index: 5; }
        .new-tag { left: 12px; background-color: var(--color-accent); }
        .status-tag { right: 12px; background-color: var(--color-urgent); }
        .status-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.85); color: #333; display: flex; justify-content: center; align-items: center; z-index: 10; font-size: 1.5rem; font-weight: 700; }
        html[data-theme='dark'] .status-overlay { background-color: rgba(0,0,0,0.8); color: white; }
        .card-content { padding: 20px; }
        
        .blog-post-preview { max-width: 100%; border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden; background: var(--color-surface);}
        .blog-post-preview img { width: 100%; height: auto; max-height: 400px; object-fit: cover; }
        .blog-post-preview .content { padding: 25px; }
        .blog-post-preview .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9em; }
        .blog-post-preview .header .tag { background: var(--color-blog); color: white; padding: 4px 10px; border-radius: 20px; font-weight: 700; }
        .blog-post-preview .header .date { color: #777; }
        html[data-theme='dark'] .blog-post-preview .header .date { color: #aaa; }
        .blog-post-preview h3 { font-size: 1.8em; margin-bottom: 20px; color: var(--color-primary); }
        .blog-post-preview .body p, .blog-post-preview .body blockquote { margin-bottom: 1.2em; line-height: 1.8; }
        .blog-post-preview .body blockquote { border-left: 4px solid var(--color-accent); padding-left: 15px; font-style: italic; color: #555; }
        html[data-theme='dark'] .blog-post-preview .body blockquote { color: #bbb; }
        .blog-post-preview .cta { margin-top: 25px; font-weight: bold; }

        @media (max-width: 992px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox"><input type="checkbox" id="checkbox" /><div class="slider round"></div></label>
        <em style="margin-left: 10px;">Modo Oscuro</em>
    </div>
    <div class="container">
        <h1>Painel de Controlo Unificado</h1>
        <div class="main-grid">
            <div class="form-section">
                <h2>1. Selecione o Tipo de Conteúdo</h2>
                <form id="unified-form" autocomplete="off" novalidate>
                    <div class="form-group">
                        <label for="post-type">Tipo de Conteúdo</label>
                        <select id="post-type">
                            <option value="emprego">Vaga de Emprego</option>
                            <option value="servico">Serviço Técnico</option>
                            <option value="habitacao">Habitação</option>
                            <option value="doacao">Pedido de Doação</option>
                            <option value="blog">Artigo de Blog</option>
                        </select>
                    </div>

                    <div id="ad-fields">
                        <div class="form-group"><label for="ad-id-number">ID do Anúncio (Ex: 25)</label><input type="number" id="ad-id-number" required><div class="error-message" id="ad-id-number-error"></div></div>
                        <div class="form-group"><label for="title">Título</label><input type="text" id="title" required><div class="error-message" id="title-error"></div></div>
                        <div class="form-group"><label for="description">Descrição</label><textarea id="description" rows="4" required></textarea><div class="error-message" id="description-error"></div></div>
                        
                        <details>
                            <summary>Mídia (Opcional)</summary>
                            <div class="details-content">
                                <div class="form-group"><label for="youtube-link">Link de Vídeo do YouTube</label><input type="url" id="youtube-link" placeholder="https://www.youtube.com/watch?v=..."></div>
                                <div class="form-group">
                                    <label for="image-input">Imagens (Máximo 5)</label>
                                    <div class="drop-zone" id="drop-zone">Arraste e solte as imagens aqui ou clique para selecionar.</div>
                                    <input type="file" id="image-input" accept="image/*" multiple hidden>
                                    <div id="image-preview-container"></div>
                                </div>
                            </div>
                        </details>
                        
                        <details>
                            <summary>Detalhes de Contacto e Publicação</summary>
                            <div class="details-content">
                                <div class="form-group"><label for="contact-phone">Telefone</label><input type="tel" id="contact-phone"></div>
                                <div class="form-group"><label for="contact-email">Email</label><input type="email" id="contact-email"></div>
                                <div class="form-group"><label for="city">Cidade</label><input type="text" id="city" required><div class="error-message" id="city-error"></div></div>
                            </div>
                        </details>

                        <details>
                            <summary>Opções de Apresentação</summary>
                            <div class="details-content">
                                <div class="form-group"><label for="ad-priority">Prioridade</label><input type="number" id="ad-priority" value="0"></div>
                                <div class="form-group"><label for="ad-status">Estado</label><select id="ad-status"><option value="disponivel">Disponível</option><option value="urgente">Urgente</option><option value="preenchido">Preenchido</option></select></div>
                                <div class="form-group">
                                    <label for="card-bg-color">Cor de Fundo</label>
                                    <input type="color" id="card-bg-color" value="#FFFFFF">
                                    <div id="color-palette"></div>
                                </div>
                                <div class="form-group form-group-checkbox"><input type="checkbox" id="is-highlighted"><label for="is-highlighted">Destacar Anúncio</label></div>
                                <div class="form-group form-group-checkbox"><input type="checkbox" id="is-new"><label for="is-new">Marcar como "Novo"</label></div>
                            </div>
                        </details>
                    </div>

                    <div id="blog-fields" style="display: none;">
                        <div class="form-group"><label for="blog-title">Título do Artigo</label><input type="text" id="blog-title" required><div class="error-message" id="blog-title-error"></div></div>
                        <div class="form-group"><label for="blog-author">Autor</label><input type="text" id="blog-author" value="PortugalApoia"></div>
                        <div class="form-group"><label for="blog-category">Categoria</label>
                            <select id="blog-category">
                                <option value="Emprego">Emprego</option>
                                <option value="Habitação">Habitação</option>
                                <option value="Dicas">Dicas</option>
                                <option value="Comunidade">Comunidade</option>
                                <option value="Notícias">Notícias</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="blog-image">URL da Imagem Principal</label><input type="url" id="blog-image" placeholder="https://exemplo.com/imagem.jpg" required><div class="error-message" id="blog-image-error"></div></div>
                        <div class="form-group">
                            <label for="blog-body">Corpo do Artigo</label>
                            <small>Use &lt;h3&gt;Para Subtítulos&lt;/h3&gt;, &lt;p&gt;Para parágrafos.&lt;/p&gt;. Pode colar URLs de imagens ou vídeos do YouTube diretamente.</small>
                            <textarea id="blog-body" rows="10" required></textarea>
                            <div class="error-message" id="blog-body-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="blog-quote">Cita Destacada (Opcional)</label>
                            <textarea id="blog-quote" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="blog-cta">Chamada à Ação (Opcional)</label>
                             <small>Ex: &lt;strong&gt;Consulte a nossa secção de &lt;a href="empregos.html"&gt;Emprego&lt;/a&gt;!&lt;/strong&gt;</small>
                            <input type="text" id="blog-cta">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="publication-date">Data de Publicação (para todos os tipos)</label>
                        <input type="date" id="publication-date" required>
                    </div>

                    <button type="button" id="generate-btn" class="button">Gerar Código</button>
                    <button type="button" id="clear-btn" class="button secondary" style="margin-left: 15px;">Limpar</button>
                </form>
            </div>
            <div>
                <div class="preview-section">
                    <h2>2. Pré-visualização</h2>
                    <div id="capture-area"></div>
                </div>
                <div class="preview-section" style="margin-top:30px;">
                    <h2>3. Código para Copiar</h2>
                    <div class="code-output-wrapper">
                        <pre><code id="generated-code-display" class="language-html code-output-display"></code></pre>
                        <textarea id="generated-code-anuncio" class="code-output" readonly></textarea>
                        <button class="copy-btn" id="copy-code-btn">Copiar</button>
                    </div>
                </div>
                <div class="preview-section" style="margin-top:30px;">
                    <h2>4. Hashtags Sugeridos</h2>
                     <div class="code-output-wrapper">
                        <textarea id="generated-hashtags" class="code-output" readonly style="min-height: 100px;"></textarea>
                         <button class="copy-btn" id="copy-hashtags-btn">Copiar</button>
                    </div>
                </div>
                <div class="preview-section" id="history-section">
                    <h2>5. Historial</h2>
                    <table id="history-table">
                        <thead><tr><th>Tipo</th><th>Título/ID</th><th>Data</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const elements = {
            postType: document.getElementById('post-type'),
            captureArea: document.getElementById('capture-area'),
            generatedCodeDisplay: document.getElementById('generated-code-display'),
            generatedCode: document.getElementById('generated-code-anuncio'),
            generatedHashtags: document.getElementById('generated-hashtags'),
            generateBtn: document.getElementById('generate-btn'),
            clearBtn: document.getElementById('clear-btn'),
            form: document.getElementById('unified-form'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            copyHashtagsBtn: document.getElementById('copy-hashtags-btn'),
            historyTableBody: document.querySelector('#history-table tbody'),
            publicationDate: document.getElementById('publication-date'),
            adFieldsContainer: document.getElementById('ad-fields'),
            blogFieldsContainer: document.getElementById('blog-fields'),
            ad: {
                youtubeLink: document.getElementById('youtube-link'),
                imageInput: document.getElementById('image-input'),
                dropZone: document.getElementById('drop-zone'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                idNumber: document.getElementById('ad-id-number'),
                title: document.getElementById('title'),
                description: document.getElementById('description'),
                phone: document.getElementById('contact-phone'),
                email: document.getElementById('contact-email'),
                city: document.getElementById('city'),
                priority: document.getElementById('ad-priority'),
                status: document.getElementById('ad-status'),
                bgColor: document.getElementById('card-bg-color'),
                isHighlighted: document.getElementById('is-highlighted'),
                isNew: document.getElementById('is-new'),
                colorPalette: document.getElementById('color-palette'),
            },
            blog: {
                title: document.getElementById('blog-title'),
                author: document.getElementById('blog-author'),
                category: document.getElementById('blog-category'),
                image: document.getElementById('blog-image'),
                body: document.getElementById('blog-body'),
                quote: document.getElementById('blog-quote'),
                cta: document.getElementById('blog-cta'),
            }
        };

        let imageFiles = [];
        const MAX_IMAGES = 5;

        const toggleFieldVisibility = () => {
            const type = elements.postType.value;
            elements.adFieldsContainer.style.display = (type === 'blog') ? 'none' : 'block';
            elements.blogFieldsContainer.style.display = (type === 'blog') ? 'block' : 'none';
            updatePreview();
        };

        const updatePreview = () => {
            const { type, ad, blog } = getFormData();
            elements.captureArea.innerHTML = '';
            if (type === 'blog') {
                if (!blog.title && !blog.image) return;
                const { previewHTML } = generateBlogPostHtmlAndSeo(blog);
                elements.captureArea.innerHTML = previewHTML;
            } else {
                if (!ad.title && imageFiles.length === 0 && !ad.youtubeUrl) return;
                const { fullPreviewHTML } = generateAdHtmlAndSeo(ad);
                elements.captureArea.innerHTML = fullPreviewHTML;
            }
        };

        const getFormData = () => ({
            ad: {
                type: elements.postType.value,
                id: elements.ad.idNumber.value,
                title: elements.ad.title.value,
                description: elements.ad.description.value.replace(/\n/g, '<br>'),
                phone: elements.ad.phone.value,
                email: elements.ad.email.value,
                youtubeUrl: getYouTubeEmbedUrl(elements.ad.youtubeLink.value),
                images: imageFiles,
                pubDate: elements.publicationDate.value,
                city: elements.ad.city.value,
                priority: elements.ad.priority.value || '0',
                status: elements.ad.status.value,
                bgColor: elements.ad.bgColor.value,
                isHighlighted: elements.ad.isHighlighted.checked,
                isNew: elements.ad.isNew.checked,
            },
            blog: {
                title: elements.blog.title.value,
                author: elements.blog.author.value,
                category: elements.blog.category.value,
                image: elements.blog.image.value,
                body: elements.blog.body.value,
                quote: elements.blog.quote.value,
                cta: elements.blog.cta.value,
                pubDate: elements.publicationDate.value,
            },
            type: elements.postType.value,
        });

        function generateAdHtmlAndSeo(data) {
            let cardIdPrefix = '', schemaType = 'Thing';
            switch (data.type) {
                case 'emprego': cardIdPrefix = 'EMP'; schemaType = 'JobPosting'; break;
                case 'servico': cardIdPrefix = 'SER'; schemaType = 'Service'; break;
                case 'habitacao': cardIdPrefix = 'HAB'; schemaType = 'Apartment'; break;
                case 'doacao': cardIdPrefix = 'DOA'; schemaType = 'Demand'; break;
            }
            const cardId = `${cardIdPrefix}-${data.id.padStart(3, '0')}`;
            let mediaItemsPreview = [], mediaItemsFinal = [];
            if (data.youtubeUrl) {
                const item = `<div class="card-carousel-slide"><iframe src="${data.youtubeUrl}" frameborder="0" allowfullscreen></iframe></div>`;
                mediaItemsPreview.push(item);
                mediaItemsFinal.push(item);
            }
            data.images.forEach(file => {
                mediaItemsPreview.push(`<div class="card-carousel-slide"><img src="${URL.createObjectURL(file)}" alt="Imagem do anúncio"></div>`);
                mediaItemsFinal.push(`<div class="card-carousel-slide"><img src="img_anuncios/${file.name.replace(/\s/g, '_')}" alt="Imagem do anúncio"></div>`);
            });
            let mediaHTMLPreview = '', mediaHTMLFinal = '';
            if (mediaItemsPreview.length > 0) {
                 const carouselId = `carousel-${Date.now()}`;
                 const createCarousel = (items, id) => `
                    <div class="card-carousel-container">
                        <div class="card-carousel-slides" id="${id}" data-total="${items.length}">
                            ${items.join('')}
                        </div>
                        ${items.length > 1 ? `<button class="carousel-btn prev" onclick="moveSlide('${id}', -1)">&#10094;</button><button class="carousel-btn next" onclick="moveSlide('${id}', 1)">&#10095;</button>` : ''}
                    </div>`;
                mediaHTMLPreview = createCarousel(mediaItemsPreview, `${carouselId}-preview`);
                mediaHTMLFinal = createCarousel(mediaItemsFinal, cardId);
            }
            let contactHTML = '';
            if(data.phone) contactHTML += `<p><strong>Telefone:</strong> <a href="tel:${data.phone}">${data.phone}</a></p>`;
            if(data.email) contactHTML += `<p><strong>Email:</strong> <a href="mailto:${data.email}">${data.email}</a></p>`;
            let statusTagHTML = data.status === 'urgente' ? `<div class="status-tag">Urgente</div>` : '';
            let statusOverlayHTML = data.status === 'preenchido' ? `<div class="status-overlay">Preenchido</div>` : '';
            let newTagHTML = data.isNew ? `<div class="new-tag">Novo</div>` : '';
            const cardContent = `
                <div class="card-content">
                    <h3>${data.title}</h3>
                    <p>${data.description}</p>
                    ${contactHTML}
                    <p><small>#${cardId} | ${data.city}, ${data.pubDate}</small></p>
                </div>`;
            const cardClasses = `card-causa ${data.isHighlighted ? 'destacado' : ''}`;
            const dataAttributes = `id="${cardId}" data-publication-date="${data.pubDate}" data-city="${data.city}" data-priority="${data.priority}"`;
            const fullPreviewHTML = `<div class="${cardClasses}" style="background-color: ${data.bgColor};">${statusOverlayHTML}${newTagHTML}${statusTagHTML}${mediaHTMLPreview}${cardContent}</div>`;
            const cardHTML = `<div class="${cardClasses}" ${dataAttributes} style="background-color: ${data.bgColor};">${statusOverlayHTML}${newTagHTML}${statusTagHTML}${mediaHTMLFinal}${cardContent}</div>`;
            const schema = { "@context": "https://schema.org", "@type": schemaType, "name": data.title, "description": data.description.replace(/<br>/g, ' '), "identifier": cardId, "datePosted": data.pubDate };
            if(data.youtubeUrl) schema.video = { "@type": "VideoObject", "embedUrl": data.youtubeUrl };
            const seoHTML = `<script type="application/ld+json">\n${JSON.stringify(schema, null, 2)}\n<\/script>`;
            const scriptHTML = mediaItemsPreview.length > 1 ? `
<script>
    if (typeof window.moveSlide !== 'function') {
        window.slideStates = window.slideStates || {};
        window.moveSlide = function(carouselId, direction) {
            const slides = document.getElementById(carouselId);
            if (!slides) return;
            const totalSlides = parseInt(slides.dataset.total) || slides.children.length;
            if (window.slideStates[carouselId] === undefined) window.slideStates[carouselId] = 0;
            window.slideStates[carouselId] = (window.slideStates[carouselId] + direction + totalSlides) % totalSlides;
            slides.style.transform = \`translateX(-\${window.slideStates[carouselId] * 100}%)\`;
        }
    }
<\/script>` : '';
            return { cardHTML, fullPreviewHTML, scriptHTML, seoHTML };
        }

        function generateBlogPostHtmlAndSeo(data) {
            const formattedDate = new Date(data.pubDate).toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            let bodyHTML = data.body.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
            bodyHTML = `<p>${bodyHTML}</p>`;
            bodyHTML = bodyHTML.replace(/https?:\/\/(www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/g, '<iframe width="560" height="315" src="https://www.youtube.com/embed/$2" frameborder="0" allowfullscreen style="max-width:100%; margin: 15px 0; border-radius: 8px;"></iframe>');
            bodyHTML = bodyHTML.replace(/https?:\/\/[^\s]+?\.(jpg|jpeg|png|gif|webp)/g, '<img src="$&" alt="Imagem do artigo" style="width:100%; height:auto; border-radius:8px; margin:15px 0;">');

            if (data.quote) bodyHTML += `<blockquote>${data.quote}</blockquote>`;
            if (data.cta) bodyHTML += `<p class="cta">${data.cta}</p>`;

            const articleHTML = `
                <article class="blog-post">
                    <img src="${data.image}" alt="${data.title}" class="blog-post-image">
                    <div class="blog-post-content">
                        <div class="blog-post-header">
                            <span class="card-tag card-tag-blog">${data.category}</span>
                            <span class="card-date">${formattedDate}</span>
                        </div>
                        <h2 class="blog-post-title">${data.title}</h2>
                        <div class="blog-post-body">${bodyHTML}</div>
                    </div>
                </article>`;

            const previewHTML = `
                <div class="blog-post-preview">
                    ${data.image ? `<img src="${data.image}" alt="Preview da imagem principal">` : ''}
                    <div class="content">
                        <div class="header">
                            <span class="tag">${data.category}</span>
                            <span class="date">${formattedDate}</span>
                        </div>
                        <h3>${data.title}</h3>
                        <div class="body">${bodyHTML}</div>
                    </div>
                </div>`;
            
            const schema = {
                "@context": "https://schema.org",
                "@type": "BlogPosting",
                "headline": data.title,
                "image": data.image,
                "author": { "@type": "Organization", "name": data.author },
                "datePublished": data.pubDate,
                "articleBody": data.body.replace(/(<([^>]+)>)/ig, ''),
            };

            const seoHTML = `<script type="application/ld+json">\n${JSON.stringify(schema, null, 2)}\n<\/script>`;
            return { articleHTML, previewHTML, seoHTML };
        }
        
        elements.generateBtn.addEventListener('click', () => {
            const { type, ad, blog } = getFormData();
            if (!validateForm(type)) {
                alert("Por favor, preencha todos os campos obrigatórios marcados a vermelho.");
                return;
            }
            let finalCode = '', hashtags = '';
            if (type === 'blog') {
                const { articleHTML, seoHTML } = generateBlogPostHtmlAndSeo(blog);
                finalCode = seoHTML + '\n' + articleHTML;
                hashtags = generateHashtags({ type: 'blog', title: blog.title, category: blog.category });
            } else {
                const { cardHTML, scriptHTML, seoHTML } = generateAdHtmlAndSeo(ad);
                finalCode = seoHTML + '\n' + cardHTML + '\n\n' + scriptHTML;
                hashtags = generateHashtags(ad);
            }
            elements.generatedCode.value = finalCode;
            elements.generatedCodeDisplay.innerHTML = Prism.highlight(finalCode, Prism.languages.html, 'html');
            elements.generatedHashtags.value = hashtags;
            updateHistory(getFormData());
        });

        const validateForm = (type) => {
            let isValid = true;
            let requiredFieldIds = [];
            document.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            if (type === 'blog') {
                requiredFieldIds = ['blog-title', 'blog-image', 'blog-body'];
            } else {
                requiredFieldIds = ['ad-id-number', 'title', 'description', 'city'];
            }
            
            requiredFieldIds.forEach(id => {
                const input = document.getElementById(id);
                const errorDiv = document.getElementById(`${id}-error`);
                if (!input.value.trim()) {
                    isValid = false;
                    input.classList.add('invalid');
                    if (errorDiv) {
                        errorDiv.textContent = 'Este campo é obrigatório.';
                        errorDiv.style.display = 'block';
                    }
                }
            });
            return isValid;
        };
        
        function generateHashtags(data) {
            const hashtags = new Set(['#portugalapoia', '#comunidade', '#solidariedade', '#portugal']);
            if (data.type === 'blog') {
                hashtags.add('#blog');
                if (data.category) hashtags.add(`#${data.category.toLowerCase().replace(/\s/g, '')}`);
            } else {
                if (data.isNew) hashtags.add('#novidade');
                if (data.status === 'urgente') hashtags.add('#urgente');
                switch (data.type) {
                    case 'emprego': hashtags.add('#emprego'); hashtags.add('#vaga'); break;
                    case 'servico': hashtags.add('#servicos'); break;
                    case 'habitacao': hashtags.add('#habitacao'); hashtags.add('#arrendamento'); break;
                    case 'doacao': hashtags.add('#doacao'); break;
                }
                if (data.city) hashtags.add(`#${data.city.toLowerCase().replace(/\s/g, '')}`);
            }
            data.title.split(' ').forEach(word => { if (word.length > 3) hashtags.add(`#${word.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")}`); });
            return Array.from(hashtags).join(' ');
        }
        
        const saveFormState = () => {
            const state = getFormData();
            state.ad.images = [];
            localStorage.setItem('unifiedFormState', JSON.stringify(state));
        };

        const restoreFormState = (state) => {
            elements.postType.value = state.type || 'emprego';
            toggleFieldVisibility();
            if (state.type === 'blog') {
                Object.keys(elements.blog).forEach(key => { if (elements.blog[key] && state.blog) elements.blog[key].value = state.blog[key] || ''; });
                elements.publicationDate.value = state.blog.pubDate;
            } else {
                Object.keys(elements.ad).forEach(key => {
                    const el = elements.ad[key];
                    if (el && typeof el.value !== 'undefined') {
                        if (el.type === 'checkbox') el.checked = state.ad[key] || false;
                        else el.value = (key === 'description' && state.ad[key]) ? state.ad[key].replace(/<br>/g, '\n') : state.ad[key] || '';
                    }
                });
                elements.publicationDate.value = state.ad.pubDate;
            }
            updatePreview();
        };

        const savedState = localStorage.getItem('unifiedFormState');
        if (savedState) if (confirm("Foram encontrados dados da sessão anterior. Deseja restaurá-los?")) restoreFormState(JSON.parse(savedState)); else localStorage.removeItem('unifiedFormState');

        let adHistory = JSON.parse(localStorage.getItem('adHistory')) || [];
        const updateHistory = (formData) => {
            const entry = {
                type: formData.type,
                title: formData.type === 'blog' ? formData.blog.title : formData.ad.title,
                id: formData.type === 'blog' ? new Date().getTime() : formData.ad.id,
                date: new Date().toLocaleString('pt-PT'),
                fullData: formData
            };
            adHistory.unshift(entry);
            adHistory = adHistory.slice(0, 5);
            localStorage.setItem('adHistory', JSON.stringify(adHistory));
            renderHistory();
        };

        const renderHistory = () => {
            elements.historyTableBody.innerHTML = '';
            adHistory.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${entry.type}</td><td>${entry.title || entry.id}</td><td>${entry.date}</td><td><button type="button" class="button small" data-history-index="${index}">Restaurar</button></td>`;
                elements.historyTableBody.appendChild(row);
            });
        };

        elements.historyTableBody.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.historyIndex) {
                const index = event.target.dataset.historyIndex;
                if (adHistory[index] && confirm(`Deseja restaurar "${adHistory[index].title}"?`)) restoreFormState(adHistory[index].fullData);
            }
        });
        
        document.querySelectorAll('#unified-form input, #unified-form textarea, #unified-form select').forEach(el => el.addEventListener('input', () => { updatePreview(); saveFormState(); }));
        elements.postType.addEventListener('change', toggleFieldVisibility);

        // --- MODO OSCURO (CORREGIDO) ---
        const themeSwitch = document.getElementById('checkbox');
        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeSwitch.checked = theme === 'dark';
        };
        themeSwitch.addEventListener('change', () => applyTheme(themeSwitch.checked ? 'dark' : 'light'));
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) applyTheme(savedTheme);


        // --- RESTO DE FUNCIONES AUXILIARES ---
        const PREDEFINED_COLORS = ['#FFFFFF', '#F8F9FA', '#EAF6F1', '#D4E6F1', '#FEF9E7', '#FADBD8'];
        PREDEFINED_COLORS.forEach(color => { const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = color; swatch.addEventListener('click', () => { elements.ad.bgColor.value = color; updatePreview(); }); elements.ad.colorPalette.appendChild(swatch); });
        elements.clearBtn.addEventListener('click', () => { if (confirm("Tem a certeza que deseja limpar todos os campos?")) { elements.form.reset(); elements.publicationDate.valueAsDate = new Date(); imageFiles = []; updateImagePreview(); updatePreview(); elements.generatedCode.value = ""; elements.generatedCodeDisplay.innerHTML = ""; elements.generatedHashtags.value = ""; localStorage.removeItem('unifiedFormState'); }});
        elements.copyCodeBtn.addEventListener('click', () => copyToClipboard(elements.generatedCode.value, 'Código'));
        elements.copyHashtagsBtn.addEventListener('click', () => copyToClipboard(elements.generatedHashtags.value, 'Hashtags'));
        function copyToClipboard(text, type) { if (!text) { alert(`${type} está vazio.`); return; } navigator.clipboard.writeText(text).then(() => alert(`${type} copiado para a área de transferência!`)); }
        function getYouTubeEmbedUrl(url) { if (!url) return null; let videoId; try { const urlObj = new URL(url); if (urlObj.hostname === 'youtu.be') videoId = urlObj.pathname.slice(1); else videoId = urlObj.searchParams.get('v'); } catch (e) { return null; } return videoId ? `https://www.youtube.com/embed/${videoId}` : null; }
        elements.ad.dropZone.addEventListener('click', () => elements.ad.imageInput.click());
        elements.ad.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); elements.ad.dropZone.classList.add('dragover'); });
        elements.ad.dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); elements.ad.dropZone.classList.remove('dragover'); });
        elements.ad.dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); elements.ad.dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        elements.ad.imageInput.addEventListener('change', (event) => handleFiles(event.target.files));
        function handleFiles(files) { const newFiles = Array.from(files).filter(f => f.type.startsWith('image/')); const remaining = MAX_IMAGES - imageFiles.length; if (newFiles.length > remaining) alert(`Pode carregar no máximo ${MAX_IMAGES} imagens. Apenas as ${remaining} primeiras serão adicionadas.`); imageFiles.push(...newFiles.slice(0, remaining)); updateImagePreview(); updatePreview(); }
        function updateImagePreview() { elements.ad.imagePreviewContainer.innerHTML = ''; imageFiles.forEach((file, index) => { const wrap = document.createElement('div'); wrap.className = 'img-preview'; const img = document.createElement('img'); img.src = URL.createObjectURL(file); const rmv = document.createElement('button'); rmv.className = 'remove-img-btn'; rmv.innerHTML = '&times;'; rmv.onclick = () => { imageFiles.splice(index, 1); updateImagePreview(); updatePreview(); }; wrap.append(img, rmv); elements.ad.imagePreviewContainer.appendChild(wrap); }); }

        toggleFieldVisibility();
        elements.publicationDate.valueAsDate = new Date();
        renderHistory();
    });
    </script>
</body>
</html>