<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VG454Y1YV4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-VG454Y1YV4');
    </script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3196299619563199"
        crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliador Urbano PRO - PortugalApoia</title>
    <meta name="description"
        content="Ferramenta profissional e completa para avaliação comercial de imóveis urbanos, com relatórios detalhados, gráficos analíticos e registo fotográfico.">
    <link rel="apple-touch-icon" href="/images/favicon.ico.png">
    <link rel="canonical" href="https://portugalapoia.com/app_avaliadorurbano.html">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" media="print"
        onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    </noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    </noscript>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&display=swap"
        media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&display=swap">
    </noscript>
    <link rel="stylesheet" href="style.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="style.css">
    </noscript>
    <link rel="stylesheet" href="avaliador-urbano-style.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="avaliador-urbano-style.css">
    </noscript>
    <link rel="icon" href="images/favicon.ico.png" type="image/png">

    <style>
        /* Estilos para a impressão profissional do relatório */
        @media print {
            @page {
                size: A4;
                margin: 1.5cm;
                /* Margens da página */
            }

            body,
            .avaliador-urbano-container,
            .modal-content {
                background-color: #fff !important;
                box-shadow: none !important;
                border: none !important;
                color: #000 !important;
            }

            .modal-header,
            .modal-footer,
            .main-header,
            main>section:first-of-type,
            form,
            footer {
                display: none !important;
            }

            .modal {
                position: static !important;
                display: block !important;
                overflow: visible !important;
            }

            .modal-dialog {
                max-width: 100% !important;
                margin: 0 !important;
            }

            .modal-body {
                padding: 0 !important;
            }

            .report-page {
                page-break-after: always;
            }

            .report-page:last-child {
                page-break-after: auto;
            }

            .report-section,
            .photo-block {
                page-break-inside: avoid;
            }

            .photo-report-section {
                page-break-before: always;
            }

            .photo-block {
                width: 100%;
                margin-bottom: 1cm;
            }

            .photo-block img {
                max-width: 100%;
                max-height: 20cm;
                /* Limita a altura da imagem na impressão */
                border: 1px solid #ccc;
            }

            .chart-container {
                width: 100% !important;
                max-width: 18cm !important;
                height: auto !important;
                margin: 20px auto;
            }

            canvas {
                max-width: 100% !important;
            }
        }
    </style>
</head>

<body>
    <header class="main-header">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand logo" href="index.html">PortugalApoia</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-nav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="main-nav">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item"><a class="nav-link" href="doacoes.html">Doações</a></li>
                        <li class="nav-item"><a class="nav-link" href="empregos.html">Emprego</a></li>
                        <li class="nav-item"><a class="nav-link" href="servicos.html">Serviços</a></li>
                        <li class="nav-item"><a class="nav-link" href="habitação.html">Habitação</a></li>
                        <li class="nav-item dropdown active">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownWebApp" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Apps
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdownWebApp">
                                <a class="dropdown-item" href="app_evaluadorsustentable.html">Avaliador Sustentável
                                    PRO</a>
                                <a class="dropdown-item" href="app_avaliadorurbano.html">Avaliador de Imóveis
                                    Urbanos</a>
                            </div>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="blog.html">Blog</a></li>
                        <li class="nav-item"><a class="nav-link btn btn-primary publish-btn"
                                href="publicar.html">Publicar</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section class="page-header page-header-avaliador-urbano text-center">
            <div class="container">
                <h1 class="page-title">Avaliador Urbano PRO</h1>
                <p class="lead">Ferramenta avançada para avaliações comerciais de imóveis urbanos com relatórios
                    detalhados.</p>
            </div>
        </section>

        <div class="avaliador-urbano-container my-5">
            <form id="avaliador-urbano-app" onsubmit="return false;">

                <div class="form-section">
                    <h3>1. Dados Gerais da Avaliação</h3>
                    <div class="form-group">
                        <label for="nomeSolicitante">Identificação do Solicitante</label>
                        <input type="text" class="form-control" id="nomeSolicitante"
                            placeholder="Nome e identificação do solicitante">
                    </div>
                    <div class="form-group">
                        <label for="nomeAvaliador">Identificação do Avaliador</label>
                        <input type="text" class="form-control" id="nomeAvaliador" placeholder="Nome do avaliador">
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="idAvaliador">Nº de Cédula</label>
                            <input type="text" class="form-control" id="idAvaliador" placeholder="Ex: 123456789">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="regAvaliador">Nº de Registo</label>
                            <input type="text" class="form-control" id="regAvaliador" placeholder="Ex: CMVM/0001">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="objetoAvaliacao">Objeto da Avaliação</label>
                        <textarea class="form-control" id="objetoAvaliacao" rows="2"
                            placeholder="Descreva o propósito da avaliação (ex: compra e venda, garantia hipotecária, etc.)."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="dataVisita">Data da Visita</label>
                            <input type="date" class="form-control" id="dataVisita">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="dataRelatorio">Data do Relatório</label>
                            <input type="date" class="form-control" id="dataRelatorio">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>2. Tipo e Detalhes do Imóvel</h3>
                    <div class="form-group">
                        <label for="tipoInmueble">Tipo de Imóvel</label>
                        <select class="form-control" id="tipoInmueble">
                            <option value="selecione">Selecione o tipo...</option>
                            <option value="Apartamento">Apartamento</option>
                            <option value="Moradia">Moradia</option>
                            <option value="Terreno">Terreno Urbano</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h3>3. Morada do Imóvel</h3>
                    <div class="form-row">
                        <div class="form-group col-md-6"><label for="cidadeImovel">Cidade</label><input type="text"
                                class="form-control" id="cidadeImovel" placeholder="Ex: Lisboa, Porto, Coimbra"></div>
                        <div class="form-group col-md-6"><label for="codigoPostalImovel">Código Postal</label><input
                                type="text" class="form-control" id="codigoPostalImovel" placeholder="Ex: 4000-447">
                        </div>
                    </div>
                    <div class="form-group"><label for="moradaImovel">Morada Completa</label><input type="text"
                            class="form-control" id="moradaImovel" placeholder="Ex: Rua de Santa Catarina, 123"></div>
                </div>

                <div class="form-section">
                    <h3>4. Características do Imóvel <i class="fas fa-home"></i></h3>
                    <div class="form-group highlighted-input-group"><label for="area-construcao">Área Bruta Privativa
                            (m²)</label><input type="number" id="area-construcao" min="0" class="form-control"
                            placeholder="Introduza a área total de construção"></div>
                    <div class="property-features-grid">
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-bed"></i></div><label for="qtd-quartos"
                                class="feature-label">Quartos</label>
                            <div class="feature-quantity"><input type="number" id="qtd-quartos" name="qtd_quartos"
                                    min="0" value="3" class="form-control"></div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-bath"></i></div><label for="qtd-banos"
                                class="feature-label">Casa de Banho</label>
                            <div class="feature-quantity"><input type="number" id="qtd-banos" name="qtd_banos" min="0"
                                    value="2" class="form-control"></div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon"><i class="fas fa-car"></i></div><label for="qtd-garagem"
                                class="feature-label">Garagem (vagas)</label>
                            <div class="feature-quantity"><input type="number" id="qtd-garagem" name="qtd_garagem"
                                    min="0" value="1" class="form-control"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>5. Acabamentos e Materiais de Construção</h3>
                    <div class="finishes-grid">
                        <div class="finish-item">
                            <div class="finish-icon"><i class="fas fa-border-style"></i></div><label
                                class="finish-label">Muros / Paredes</label><select class="form-control mb-2"
                                id="material_muros">
                                <option>Tijolo</option>
                                <option>Bloco de Betão</option>
                                <option>Betão Armado</option>
                                <option>Drywall (Gesso)</option>
                                <option>Madeira</option>
                            </select>
                            <div class="evaluation-group"><label><input type="radio" name="estado_muros" value="bom"
                                        checked>
                                    Bom</label><label><input type="radio" name="estado_muros" value="regular">
                                    Regular</label><label><input type="radio" name="estado_muros" value="mau">
                                    Mau</label></div>
                        </div>
                        <div class="finish-item">
                            <div class="finish-icon"><i class="fas fa-palette"></i></div><label
                                class="finish-label">Revestimentos</label><select class="form-control mb-2"
                                id="material_revestimentos">
                                <option>Pintura Plástica</option>
                                <option>Cerâmica</option>
                                <option>Papel de Parede</option>
                                <option>Madeira</option>
                            </select>
                            <div class="evaluation-group"><label><input type="radio" name="estado_revestimentos"
                                        value="bom" checked> Bom</label><label><input type="radio"
                                        name="estado_revestimentos" value="regular"> Regular</label><label><input
                                        type="radio" name="estado_revestimentos" value="mau"> Mau</label></div>
                        </div>
                        <div class="finish-item">
                            <div class="finish-icon"><i class="fas fa-shoe-prints"></i></div><label
                                class="finish-label">Pisos</label><select class="form-control mb-2" id="material_pisos">
                                <option>Cerâmica</option>
                                <option>Soalho Flutuante</option>
                                <option>Madeira Maciça</option>
                                <option>Mármore/Granito</option>
                            </select>
                            <div class="evaluation-group"><label><input type="radio" name="estado_pisos" value="bom"
                                        checked>
                                    Bom</label><label><input type="radio" name="estado_pisos" value="regular">
                                    Regular</label><label><input type="radio" name="estado_pisos" value="mau">
                                    Mau</label></div>
                        </div>
                        <div class="finish-item">
                            <div class="finish-icon"><i class="fas fa-door-closed"></i></div><label
                                class="finish-label">Carpintaria</label><select class="form-control mb-2"
                                id="material_carpintaria">
                                <option>Madeira Maciça</option>
                                <option>MDF Lacado</option>
                                <option>Alumínio</option>
                                <option>PVC</option>
                            </select>
                            <div class="evaluation-group"><label><input type="radio" name="estado_carpintaria"
                                        value="bom" checked>
                                    Bom</label><label><input type="radio" name="estado_carpintaria" value="regular">
                                    Regular</label><label><input type="radio" name="estado_carpintaria" value="mau">
                                    Mau</label></div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>6. Análise Qualitativa (SWOT)</h3>
                    <div class="form-group">
                        <label for="swot-strengths"><strong><i class="fas fa-thumbs-up text-success"></i> Pontos Fortes
                                (Strengths)</strong></label>
                        <textarea id="swot-strengths" class="form-control" rows="3"
                            placeholder="Ex: Localização central, boa exposição solar, acabamentos de alta qualidade..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="swot-weaknesses"><strong><i class="fas fa-thumbs-down text-danger"></i> Pontos
                                Fracos (Weaknesses)</strong></label>
                        <textarea id="swot-weaknesses" class="form-control" rows="3"
                            placeholder="Ex: Necessita de remodelação, ausência de garagem, fraco isolamento acústico..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="swot-opportunities"><strong><i class="fas fa-lightbulb text-info"></i> Oportunidades
                                (Opportunities)</strong></label>
                        <textarea id="swot-opportunities" class="form-control" rows="3"
                            placeholder="Ex: Nova linha de metro nas proximidades, valorização da zona, potencial para arrendamento turístico..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="swot-threats"><strong><i class="fas fa-exclamation-triangle text-warning"></i>
                                Ameaças (Threats)</strong></label>
                        <textarea id="swot-threats" class="form-control" rows="3"
                            placeholder="Ex: Excesso de oferta na zona, restrições urbanísticas, degradação da vizinhança..."></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>7. Registo Fotográfico (Anexos)</h3>
                    <p class="text-muted">Anexe até 20 fotografias do imóvel. Apenas as fotografias carregadas
                        aparecerão no relatório.</p>
                    <div id="photo-upload-container"></div>
                    <button type="button" id="add-photo-btn" class="btn btn-secondary mt-3"><i class="fas fa-plus"></i>
                        Adicionar Fotografia</button>
                </div>

                <div class="form-section">
                    <h3>8. Método de Valorização</h3>
                    <div id="terrain-valuation" class="conditional-details" style="display: block;">
                        <h4 class="h5">8.1 Valorização do Terreno</h4>
                        <p><strong>Método Utilizado:</strong> Método Comparativo de Mercado</p>
                        <div class="form-group highlighted-input-group"><label for="area-terreno-imovel">Área do Terreno
                                do Imóvel (m²)</label><input type="number" id="area-terreno-imovel" min="0"
                                class="form-control" placeholder="Introduza a área do seu terreno"></div>
                        <div class="table-responsive">
                            <table id="terrain-comparison-table" class="table table-bordered table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Amostra</th>
                                        <th>Localização da Amostra</th>
                                        <th>Área (m²)</th>
                                        <th>Valor por m² (€)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td><input type="text" class="form-control"></td>
                                        <td><input type="number" min="0" class="form-control"></td>
                                        <td><input type="number" min="0" class="form-control"></td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td><input type="text" class="form-control"></td>
                                        <td><input type="number" min="0" class="form-control"></td>
                                        <td><input type="number" min="0" class="form-control"></td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td><input type="text" class="form-control"></td>
                                        <td><input type="number" min="0" class="form-control"></td>
                                        <td><input type="number" min="0" class="form-control"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="construction-valuation">
                        <h4 class="h5 mt-4">8.2 Valorização da Construção</h4>
                        <p><strong>Método Utilizado:</strong> Custo de Reposição (Fito-Corvini)</p>
                        <div class="form-row">
                            <div class="form-group col-md-6 highlighted-input-group">
                                <label for="custo-direto">Custos Diretos (CD) por m² (€)</label>
                                <div class="input-group">
                                    <input type="number" id="custo-direto" min="0" class="form-control"
                                        placeholder="Ex: 1350">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" id="suggested-cost-btn"
                                            title="Usar custo médio sugerido">Sugerir</button>
                                    </div>
                                </div>
                                <small id="suggested-cost-text" class="form-text text-muted"
                                    style="display:none;"></small>
                            </div>
                            <div class="form-group col-md-6 highlighted-input-group">
                                <label for="custo-indireto">Custos Indiretos (CI) - % de CD</label>
                                <input type="number" id="custo-indireto" min="0" max="100" class="form-control"
                                    placeholder="Ex: 25" value="25">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6 highlighted-input-group">
                                <label for="beneficio">Benefício (B) - % de (CD+CI)</label>
                                <input type="number" id="beneficio" min="0" max="100" class="form-control"
                                    placeholder="Ex: 10" value="10">
                            </div>
                            <div class="form-group col-md-6 highlighted-input-group">
                                <label for="depreciacao">Depreciação (D) - % do VC</label>
                                <div class="input-group">
                                    <input type="number" id="depreciacao" min="0" max="100" class="form-control"
                                        placeholder="Calcular com Fito-Corvini">
                                    <div class="input-group-append">
                                        <button class="btn btn-secondary" type="button" id="openFitoCorviniModal"
                                            title="Calcular Depreciação com Tabela de Fito-Corvini"><i
                                                class="fas fa-calculator"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="valuation-results-box mt-4">
                        <div class="result-item"><span>Custo de Reposição (CR) da Construção:</span><strong
                                id="total-construction-value">€ 0,00</strong></div>
                        <div class="result-item"><span>(+) Valor Estimado do Terreno:</span><strong
                                id="total-terrain-value">€ 0,00</strong></div>
                        <div class="result-item final-value"><span>(=) Valor Total Estimado do Imóvel:</span><strong
                                id="total-property-value">€ 0,00</strong></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>9. Análise de Rentabilidade (Arrendamento)</h3>
                    <div class="form-group">
                        <label for="acquisition-value">Valor de Aquisição (ou Valor Total Estimado)</label>
                        <div class="input-group">
                            <input type="number" id="acquisition-value" class="form-control"
                                placeholder="Introduza o custo total de aquisição">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"
                                    id="use-estimated-value-btn">Usar Valor Estimado</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="annual-costs">Custos Anuais (IMI, condomínio, manutenção, etc.)</label>
                        <input type="number" id="annual-costs" class="form-control"
                            placeholder="Introduza a soma de todos os custos anuais">
                    </div>
                    <div class="form-group">
                        <label for="rent-city">Cidade para Cálculo da Renda</label>
                        <select id="rent-city" class="form-control"></select>
                    </div>
                    <div id="profitability-results" class="valuation-results-box mt-4" style="display:none;">
                        <div class="result-item"><span>Rentabilidade Bruta Anual (Yield):</span><strong
                                id="gross-yield-result">0.00%</strong></div>
                        <div class="result-item"><span>Renda Mensal Estimada:</span><strong id="monthly-rent-result">€
                                0,00</strong></div>
                        <div class="result-item"><span>Retorno Sobre o Investimento (ROI) Anual:</span><strong
                                id="roi-result">0.00%</strong></div>
                        <div class="result-item final-value"><span>Tempo de Retorno da Inversão:</span><strong
                                id="payback-result">N/A</strong></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>10. Conclusões e Observações Finais</h3>
                    <div class="form-group">
                        <label for="final-remarks">Parecer Final do Avaliador</label>
                        <textarea id="final-remarks" class="form-control" rows="5"
                            placeholder="Descreva as suas conclusões finais sobre o valor, estado e potencial do imóvel."></textarea>
                    </div>
                </div>


                <button type="submit" class="submit-button">Gerar Relatório de Avaliação</button>
            </form>
        </div>
    </main>

    <footer class="main-footer"></footer>

    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Relatório de Avaliação de Imóvel</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body" id="reportOutput"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="printReport();"><i
                            class="fas fa-print mr-2"></i>Imprimir Relatório</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="fitoCorviniModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fitoCorviniModalLabel">Calculadora de Depreciação (Fito-Corvini)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="applyFitoValue">Aplicar %</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="script.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- BASE DE DADOS E VARIÁVEIS GLOBAIS ---
            const RENTAL_YIELDS = {
                "Lisboa": 4.7, "Porto": 5.7, "Coimbra": 6.9, "Braga": 6.5, "Faro": 5.5,
                "Aveiro": 5.2, "Setúbal": 5.4, "Leiria": 6.3, "Santarém": 7.5, "Castelo Branco": 8.6,
                "Outra": 6.0 // Média nacional como fallback
            };
            const SUGGESTED_CONSTRUCTION_COST = 1350;

            const form = document.getElementById('avaliador-urbano-app');
            const photoUploadContainer = document.getElementById('photo-upload-container');
            const addPhotoBtn = document.getElementById('add-photo-btn');
            let photoCounter = 0;
            const MAX_PHOTOS = 20;
            let valueBreakdownChart, profitabilityChart;

            // --- INICIALIZAÇÃO DO FORMULÁRIO ---

            const citySelect = document.getElementById('rent-city');
            Object.keys(RENTAL_YIELDS).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            function createPhotoInput(index) {
                const div = document.createElement('div');
                div.className = 'photo-input-group border rounded p-3 mb-3';
                div.innerHTML = `
                    <div class="form-row">
                        <div class="form-group col-md-5 mb-md-0">
                            <label for="photo-file-${index}">Fotografia ${index}</label>
                            <input type="file" class="form-control-file photo-file" id="photo-file-${index}" data-index="${index}" accept="image/*">
                            <div class="mt-2" id="photo-preview-${index}" style="max-height: 150px; overflow: hidden;"></div>
                        </div>
                        <div class="form-group col-md-7 mb-0">
                            <label for="photo-desc-${index}">Descrição da Fotografia</label>
                            <textarea class="form-control photo-desc" id="photo-desc-${index}" rows="4" placeholder="Ex: Fachada principal, vista da varanda, etc."></textarea>
                        </div>
                    </div>`;
                photoUploadContainer.appendChild(div);

                document.getElementById(`photo-file-${index}`).addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const previewContainer = document.getElementById(`photo-preview-${index}`);
                    previewContainer.innerHTML = '';
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.style.maxWidth = '100%';
                        img.style.maxHeight = '150px';
                        img.style.objectFit = 'cover';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                });
            }

            addPhotoBtn.addEventListener('click', () => {
                if (photoCounter < MAX_PHOTOS) {
                    photoCounter++;
                    createPhotoInput(photoCounter);
                    if (photoCounter === MAX_PHOTOS) addPhotoBtn.style.display = 'none';
                }
            });

            addPhotoBtn.click(); // Adiciona o primeiro campo de foto

            // --- FUNÇÕES DE CÁLCULO ---
            function calculateAndDisplayAll() {
                // Cálculo da Valorização
                let terrainValue = 0;
                const terrainArea = parseFloat(document.getElementById('area-terreno-imovel').value) || 0;
                let totalValM2 = 0;
                let sampleCount = 0;
                document.querySelectorAll('#terrain-comparison-table tbody tr').forEach(row => {
                    const valM2 = parseFloat(row.cells[3].querySelector('input').value);
                    if (!isNaN(valM2) && valM2 > 0) {
                        totalValM2 += valM2;
                        sampleCount++;
                    }
                });
                const avgValM2 = sampleCount > 0 ? totalValM2 / sampleCount : 0;
                terrainValue = terrainArea * avgValM2;
                document.getElementById('total-terrain-value').textContent = `€ ${terrainValue.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                const constructionArea = parseFloat(document.getElementById('area-construcao').value) || 0;
                const cd = parseFloat(document.getElementById('custo-direto').value) || 0;
                const ci = (parseFloat(document.getElementById('custo-indireto').value) || 0) / 100;
                const b = (parseFloat(document.getElementById('beneficio').value) || 0) / 100;
                const d = (parseFloat(document.getElementById('depreciacao').value) || 0) / 100;

                const vc = cd * (1 + ci) * (1 + b) * constructionArea;
                const constructionValue = vc * (1 - d);
                document.getElementById('total-construction-value').textContent = `€ ${constructionValue.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                const totalPropertyValue = terrainValue + constructionValue;
                document.getElementById('total-property-value').textContent = `€ ${totalPropertyValue.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Cálculo de Rentabilidade
                const acquisitionValue = parseFloat(document.getElementById('acquisition-value').value) || 0;
                const annualCosts = parseFloat(document.getElementById('annual-costs').value) || 0;
                const selectedCity = document.getElementById('rent-city').value;
                const yieldPercent = RENTAL_YIELDS[selectedCity] || 0;

                if (acquisitionValue > 0) {
                    const grossAnnualRent = acquisitionValue * (yieldPercent / 100);
                    const netAnnualRent = grossAnnualRent - annualCosts;
                    const roi = (netAnnualRent / acquisitionValue) * 100;
                    const monthlyRent = grossAnnualRent / 12;
                    let paybackYears = 'N/A';
                    if (netAnnualRent > 0) {
                        const years = acquisitionValue / netAnnualRent;
                        paybackYears = `${years.toFixed(1)} Anos`;
                    }

                    document.getElementById('gross-yield-result').textContent = `${yieldPercent.toFixed(2)}%`;
                    document.getElementById('monthly-rent-result').textContent = `€ ${monthlyRent.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById('roi-result').textContent = `${roi.toFixed(2)}%`;
                    document.getElementById('payback-result').textContent = paybackYears;
                    document.getElementById('profitability-results').style.display = 'block';
                } else {
                    document.getElementById('profitability-results').style.display = 'none';
                }
            }

            // Adicionar listeners a todos os campos relevantes
            const fieldsToListen = [
                'area-terreno-imovel', 'area-construcao', 'custo-direto', 'custo-indireto',
                'beneficio', 'depreciacao', 'acquisition-value', 'annual-costs', 'rent-city'
            ];
            fieldsToListen.forEach(id => document.getElementById(id).addEventListener('input', calculateAndDisplayAll));
            document.querySelectorAll('#terrain-comparison-table input').forEach(input => {
                input.addEventListener('input', calculateAndDisplayAll);
            });

            document.getElementById('use-estimated-value-btn').addEventListener('click', () => {
                const totalValueText = document.getElementById('total-property-value').textContent;
                const totalValue = parseFloat(totalValueText.replace(/[€\s.]/g, '').replace(',', '.')) || 0;
                document.getElementById('acquisition-value').value = totalValue.toFixed(2);
                calculateAndDisplayAll();
            });


            // --- GERAÇÃO DO RELATÓRIO ---
            async function generateReport() {
                const getInputValue = id => document.getElementById(id)?.value || 'N/A';
                const formatCurrency = val => `€ ${val.toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                const reportData = {
                    solicitante: getInputValue('nomeSolicitante'),
                    avaliador: getInputValue('nomeAvaliador'),
                    idAvaliador: getInputValue('idAvaliador'),
                    regAvaliador: getInputValue('regAvaliador'),
                    objeto: getInputValue('objetoAvaliacao'),
                    dataVisita: getInputValue('dataVisita'),
                    dataRelatorio: getInputValue('dataRelatorio'),
                    tipoImovel: getInputValue('tipoInmueble'),
                    moradaCompleta: `${getInputValue('moradaImovel')}, ${getInputValue('codigoPostalImovel')} ${getInputValue('cidadeImovel')}`,
                    areaConstrucao: parseFloat(getInputValue('area-construcao')) || 0,
                    areaTerreno: parseFloat(getInputValue('area-terreno-imovel')) || 0,
                    swot: {
                        strengths: getInputValue('swot-strengths').replace(/\n/g, '<br>'),
                        weaknesses: getInputValue('swot-weaknesses').replace(/\n/g, '<br>'),
                        opportunities: getInputValue('swot-opportunities').replace(/\n/g, '<br>'),
                        threats: getInputValue('swot-threats').replace(/\n/g, '<br>')
                    },
                    finalRemarks: getInputValue('final-remarks').replace(/\n/g, '<br>'),
                    valorTotal: parseFloat(document.getElementById('total-property-value').textContent.replace(/[€\s.]/g, '').replace(',', '.')) || 0,
                    valorTerreno: parseFloat(document.getElementById('total-terrain-value').textContent.replace(/[€\s.]/g, '').replace(',', '.')) || 0,
                    custoReposicao: parseFloat(document.getElementById('total-construction-value').textContent.replace(/[€\s.]/g, '').replace(',', '.')) || 0,
                    rentabilidade: {
                        yield: document.getElementById('gross-yield-result').textContent,
                        rendaMensal: document.getElementById('monthly-rent-result').textContent,
                        roi: document.getElementById('roi-result').textContent,
                        payback: document.getElementById('payback-result').textContent
                    },
                    custosAnuais: parseFloat(getInputValue('annual-costs')) || 0,
                };
                reportData.rentabilidade.rendaAnualBruta = reportData.valorTotal * (parseFloat(reportData.rentabilidade.yield) / 100);


                let photosHTML = '';
                let photoCount = 0;
                for (let i = 1; i <= photoCounter; i++) {
                    const fileInput = document.getElementById(`photo-file-${i}`);
                    if (fileInput && fileInput.files[0]) {
                        photoCount++;
                        const desc = document.getElementById(`photo-desc-${i}`).value;
                        const src = document.querySelector(`#photo-preview-${i} img`)?.src;
                        if (src) {
                            photosHTML += `
                                <div class="photo-block">
                                    <img src="${src}" alt="Fotografia ${photoCount} do Imóvel">
                                    <p class="mt-2"><strong>Fig. ${photoCount}:</strong> ${desc || 'Sem descrição.'}</p>
                                </div>`;
                        }
                    }
                }

                let reportHTML = `
                    <div class="report-page">
                        <h2 class="text-center mb-4" style="color: #005A9C;">Relatório de Avaliação de Imóvel</h2>
                        <div class="report-section"><h4>1. Dados Gerais</h4><p><strong>Solicitante:</strong> ${reportData.solicitante}</p><p><strong>Avaliador:</strong> ${reportData.avaliador} (Cédula: ${reportData.idAvaliador}, Registo: ${reportData.regAvaliador})</p><p><strong>Objeto:</strong> ${reportData.objeto}</p><p><strong>Datas:</strong> Visita a ${reportData.dataVisita}, Relatório a ${reportData.dataRelatorio}</p></div>
                        <div class="report-section"><h4>2. Detalhes do Imóvel</h4><p><strong>Tipo:</strong> ${reportData.tipoImovel}</p><p><strong>Morada:</strong> ${reportData.moradaCompleta}</p><p><strong>Área Bruta Privativa:</strong> ${reportData.areaConstrucao} m²</p><p><strong>Área do Terreno:</strong> ${reportData.areaTerreno} m²</p></div>
                        <div class="report-section"><h4>3. Resumo da Valorização</h4><p><strong>Valor Total Estimado:</strong> ${formatCurrency(reportData.valorTotal)}</p><p><strong>Valor do Terreno:</strong> ${formatCurrency(reportData.valorTerreno)}</p><p><strong>Custo de Reposição da Construção:</strong> ${formatCurrency(reportData.custoReposicao)}</p><div class="chart-container"><canvas id="valueBreakdownChart"></canvas></div></div>
                    </div>
                    <div class="report-page">
                        <div class="report-section"><h4>4. Análise de Rentabilidade</h4>
                            <p><strong>Rentabilidade Bruta (Yield) Anual Estimada:</strong> ${reportData.rentabilidade.yield}</p>
                            <p><strong>Renda Mensal Estimada:</strong> ${reportData.rentabilidade.rendaMensal}</p>
                            <p><strong>Retorno Sobre o Investimento (ROI) Anual Estimado:</strong> ${reportData.rentabilidade.roi}</p>
                            <p><strong>Tempo de Retorno da Inversão (Payback):</strong> ${reportData.rentabilidade.payback}</p>
                            <div class="chart-container"><canvas id="profitabilityChart"></canvas></div>
                        </div>
                        <div class="report-section"><h4>5. Análise SWOT</h4><strong>Pontos Fortes:</strong><div>${reportData.swot.strengths || 'N/A'}</div><br><strong>Pontos Fracos:</strong><div>${reportData.swot.weaknesses || 'N/A'}</div><br><strong>Oportunidades:</strong><div>${reportData.swot.opportunities || 'N/A'}</div><br><strong>Ameaças:</strong><div>${reportData.swot.threats || 'N/A'}</div></div>
                        <div class="report-section"><h4>6. Conclusões Finais</h4><p>${reportData.finalRemarks || 'N/A'}</p></div>
                    </div>
                    ${photosHTML ? `<div class="report-page photo-report-section"><h4 class="mb-4">Anexo Fotográfico</h4>${photosHTML}</div>` : ''}
                    <div class="report-page">
                        <div class="report-section" style="border:none;">
                            <h4>Declaração e Assinatura</h4>
                            <p class="text-muted"><small>O presente relatório foi elaborado de forma imparcial e objetiva, com base nas informações recolhidas e na metodologia descrita.</small></p>
                            <div style="margin-top: 4cm; display: flex; justify-content: space-between; text-align: center;">
                                <div style="width: 45%;"><hr style="border-top: 1px solid #333; margin-bottom: 5px;"><p class="mb-0"><strong>${reportData.avaliador}</strong></p><p class="mb-0"><small>O Avaliador</small></p></div>
                                <div style="width: 45%;"><hr style="border-top: 1px solid #333; margin-bottom: 5px;"><p class="mb-0"><strong>${reportData.solicitante}</strong></p><p class="mb-0"><small>O Solicitante</small></p></div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('reportOutput').innerHTML = reportHTML;

                // Geração de gráficos APÓS o HTML estar no DOM
                setTimeout(() => {
                    if (valueBreakdownChart) valueBreakdownChart.destroy();
                    valueBreakdownChart = new Chart(document.getElementById('valueBreakdownChart').getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Valor do Terreno', 'Valor da Construção'],
                            datasets: [{
                                data: [reportData.valorTerreno, reportData.custoReposicao],
                                backgroundColor: ['#36a2eb', '#ff6384'],
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Desglose del Valor del Inmueble' } } }
                    });

                    if (profitabilityChart) profitabilityChart.destroy();
                    profitabilityChart = new Chart(document.getElementById('profitabilityChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Análise Financeira'],
                            datasets: [
                                { label: 'Ingresos Brutos Anuales', data: [reportData.rentabilidade.rendaAnualBruta], backgroundColor: '#28a745' },
                                { label: 'Costes Anuales', data: [reportData.custosAnuais], backgroundColor: '#dc3545' },
                                { label: 'Beneficio Neto Anual', data: [reportData.rentabilidade.rendaAnualBruta - reportData.custosAnuais], backgroundColor: '#007bff' }
                            ]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Análisis de Rentabilidad Anual' } }, scales: { y: { beginAtZero: true } } }
                    });
                }, 100); // Pequeno timeout para garantir que o canvas está renderizado

                $('#reportModal').modal('show');
            }

            form.addEventListener('submit', generateReport);
        });

        function printReport() {
            window.print();
        }
    </script>
</body>

</html>